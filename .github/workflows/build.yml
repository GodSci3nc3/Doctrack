name: Build Doctrack App

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.19.0
          cache: 'npm'

      # ğŸ”§ Solo en Windows: evitar errores de permisos
      - name: Disable npm cleanup on Windows
        if: runner.os == 'Windows'
        run: |
          npm config set scripts-preinstall ""
          npm config set scripts-postinstall ""

      # ğŸš€ Instalar y construir el frontend
      - name: Install frontend dependencies & build
        run: |
          cd client
          npm install --no-audit --no-fund --loglevel=error
          npm run build
          cd ..

      # ğŸ“¦ Instalar Electron y electron-builder en raÃ­z
      - name: Install Electron builder
        run: npm install --save-dev electron electron-builder

      # ğŸ§ª Verifica que el frontend estÃ¡ listo
      - name: Confirm dist folder exists
        run: ls -l client/dist

      # ğŸ—ï¸ Build de escritorio para cada sistema
      - name: Build Electron app
        run: npx electron-builder --${{ runner.os }}

      # ğŸ’¾ Subir el instalador como artefacto
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-build
          path: dist/
